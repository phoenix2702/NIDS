<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/static/capture.css">
</head>
<body>
{% include 'nav.html' %}
<h1>Packet Capture</h1>
<!-- Main Container -->
<div class="main-container">
    <div class="content-container">
       
        <button id="startCapture" class="btn btn-success"> <i class="fas fa-play"></i> Start Capture</button>
        <button id="stopCapture" class="btn btn-danger" disabled><i class="fas fa-stop"></i> Stop Capture</button>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner-border text-primary mt-3" role="status" style="display: none;">
            <span class="sr-only">Loading...</span>
        </div>

        <!-- Status Message with Icon -->
        <p id="statusMessage" class="mt-3">
            <span id="statusIcon" class="mr-2"></span>
            <span id="statusText"></span>
        </p>

        <!-- Capture Timer -->
        <p id="captureTimer" class="mt-3 text-info" style="display: none;">
            Capture Duration: <span id="timerDisplay">0s</span>
        </p>

        <!-- Envelopes for Capture Animation -->
        <div id="envelope1" class="envelope"></div>
        <div id="envelope2" class="envelope"></div>
        <div id="envelope3" class="envelope"></div>
        <div id="envelope4" class="envelope"></div>
        <div id="envelope5" class="envelope"></div>
        <div id="envelope6" class="envelope"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    let captureInterval;

    // Function to trigger the envelope animation
    function startEnvelopeAnimation() {
        const envelopes = document.querySelectorAll('.envelope');
        envelopes.forEach((envelope, index) => {
            // Reset the envelope position before starting the animation
            envelope.style.animationDelay = `${index * 0.5}s`; // stagger the animations
            envelope.classList.remove('capture'); // Reset any previous capture state
            envelope.classList.add('fly'); // Add the fly animation class
        });
    }

    // Function to stop the envelope animation and trigger capture effect
    function stopEnvelopeAnimation() {
        const envelopes = document.querySelectorAll('.envelope');
        envelopes.forEach((envelope) => {
            envelope.classList.remove('fly'); // Stop flying animation
            envelope.classList.add('capture'); // Add capture effect
        });
    }

    // Update status message with icon
    function updateStatusMessage(data) {
        const icon = data.status === "Capture Started" ? "✔️" : "❌";
        const color = data.status === "Capture Started" ? "text-success" : "text-danger";
        $('#statusIcon').text(icon).removeClass('text-success text-danger').addClass(color);
        $('#statusText').text(data.status);
    }

    // Start the capture timer
    function startTimer() {
        let seconds = 0;
        $('#timerDisplay').text(`${seconds}s`);
        $('#captureTimer').show();
        captureInterval = setInterval(() => {
            seconds++;
            $('#timerDisplay').text(`${seconds}s`);
        }, 1000);
    }

    // Stop the capture timer
    function stopTimer() {
        clearInterval(captureInterval);
        $('#captureTimer').hide();
    }

    $('#startCapture').click(function() {
        $('#loadingSpinner').show();
        $(this).prop('disabled', true);  // Disable the start button
        $('#stopCapture').prop('disabled', false);  // Enable the stop button
        startEnvelopeAnimation(); // Start the envelope animation

        $.post('/start_capture', function(data) {
            $('#loadingSpinner').hide();
            updateStatusMessage(data);
            startTimer();
        });
    });

    $('#stopCapture').click(function() {
        $('#loadingSpinner').show();
        $(this).prop('disabled', true); // Disable stop button
        $('#startCapture').prop('disabled', false); // Enable start button

        stopEnvelopeAnimation(); // Stop the envelope animation

        $.post('/stop_capture', function(data) {
            $('#loadingSpinner').hide();
            updateStatusMessage(data);
            stopTimer();
        });
    });
</script>

</body>
</html>
